<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Sales — Apple Style</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        :root { --bg: #f5f5f7; --text: #1d1d1f; --accent: #0071e3; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 8px 10px; }
        .container { max-width: 1400px; margin: 8px auto; }
        .back-link { color: var(--accent); text-decoration: none; font-weight: 500; display: inline-block; margin-bottom: 8px; font-size: 14px; }
        h1 { font-size: 24px; font-weight: 600; margin-bottom: 10px; letter-spacing: -0.5px; }
        
        .table-card { 
            background: white; 
            border-radius: 22px; 
            box-shadow: 0 8px 30px rgba(0,0,0,0.04); 
            overflow: hidden;
        }

        /* ====== ОБГОРТКА ДЛЯ STICKY + SCROLL ====== */
        /* Sticky thead працює лише коли overflow на самій таблиці, не на батьківському div */
        .table-scroll-wrap {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-x: contain;
            /* scroll snap — фіксуємо по групах на мобільному */
            scroll-snap-type: x mandatory;
        }

        table { 
            width: max-content; 
            min-width: 100%; 
            border-collapse: collapse; 
        }

        /* ====== STICKY ЗАГОЛОВКИ ====== */
        thead th {
            position: sticky;
            top: 0;
            z-index: 12;
            background: white;
        }
        thead tr.subheader-row th {
            top: 32px;
        }
        /* Перша колонка — sticky зліва + зверху */
        thead tr:first-child th:first-child {
            left: 0;
            z-index: 22;
        }
        thead tr.subheader-row th.name-th {
            left: 0;
            z-index: 22;
            top: 32px;
        }

        /* ====== ГРУПОВІ ЗАГОЛОВКИ ====== */
        .group-header { 
            text-align: center; 
            font-size: 10px; font-weight: 800; 
            text-transform: uppercase; letter-spacing: 0.5px; 
            padding: 7px 10px; 
            border-bottom: 1px solid #d2d2d7; 
            background: white;
        }
        .group-header.group-to     { color: #0071e3; border-bottom: 3px solid #0071e3; }
        .group-header.group-serv   { color: #34c759; border-bottom: 3px solid #34c759; }
        .group-header.group-acc    { color: #ff9500; border-bottom: 3px solid #ff9500; }
        .group-header.group-checks { color: #af52de; border-bottom: 3px solid #af52de; }

        th { 
            text-align: left; 
            padding: 7px 8px; 
            color: #86868b; 
            font-size: 10px; font-weight: 600; 
            text-transform: uppercase; 
            border-bottom: 1px solid #d2d2d7; 
            background: white; 
            white-space: nowrap;
        }
        th.group-to     { color: #0071e3; }
        th.group-serv   { color: #34c759; }
        th.group-acc    { color: #ff9500; }
        th.group-checks { color: #af52de; }

        td { padding: 8px 8px; border-bottom: 1px solid #f5f5f7; font-size: 12px; white-space: nowrap; }
        
        /* Snap-точки на першій колонці кожної групи */
        .group-start { 
            border-left: 2px solid #d2d2d7 !important;
            scroll-snap-align: start;
        }



        /* ====== ФІКСОВАНА КОЛОНКА ====== */
        .name-cell, th:first-child { 
            position: sticky; left: 0; 
            background: white; 
            z-index: 10; 
            min-width: 140px; max-width: 160px;
            box-shadow: 4px 0 8px -4px rgba(0,0,0,0.1);
            white-space: normal; line-height: 1.2;
            font-weight: 600; font-size: 12px;
        }
        th:first-child { z-index: 11; }

        /* ====== СТИЛІ ЗНАЧЕНЬ ====== */
        .val-plan   { color: #86868b; font-size: 11px; }
        .val-fact   { font-weight: 600; }
        .val-pct    { font-weight: 700; text-align: right; }

        .val-fact.group-to,     .val-pct.group-to     { color: #0071e3; }
        .val-fact.group-serv,   .val-pct.group-serv   { color: #34c759; }
        .val-fact.group-acc,    .val-pct.group-acc    { color: #ff9500; }
        .val-fact.group-checks, .val-pct.group-checks { color: #af52de; }

        /* ====== РЯДОК З ЧАСОМ ====== */
        .time-row { background: #f5f5f7 !important; font-weight: 800 !important; }
        .time-row td { color: #000; }
        .time-row .name-cell { background: #f5f5f7 !important; }

        /* ====== ПІДСУМКОВІ РЯДКИ ====== */
        .summary-row { background: #e8f0fe !important; border-top: 2px solid #a8c4f0 !important; }
        .summary-row td { font-weight: 700 !important; background: #e8f0fe !important; color: #1d1d1f !important; }
        .summary-row .name-cell { background: #e8f0fe !important; }

        .loading { padding: 40px; text-align: center; color: #86868b; }
        .error { padding: 40px; text-align: center; color: #ff3b30; }

        /* ====== ДЕСКТОП ====== */
        @media (min-width: 768px) {
            .name-cell, th:first-child { min-width: 120px; max-width: 140px; }
        }

        /* ====== МОБІЛЬНА ВЕРСІЯ ====== */
        @media (max-width: 600px) {
            .name-cell, th:first-child { 
                min-width: 70px; max-width: 75px;
                padding: 6px 4px;
                font-size: 9px;
            }
            /* Кожна колонка ~(100vw - 75px) / 3 щоб рівно 3 колонки в групі */
            td:not(.name-cell), th:not(:first-child) {
                min-width: calc((100vw - 75px) / 3.2);
                padding: 7px 5px; 
                font-size: 11px;
            }
            th:not(:first-child) { font-size: 8.5px; padding: 6px 4px; }
            h1 { font-size: 20px; margin-bottom: 8px; }
            .container { padding: 6px 8px; }
            .back-link { margin-bottom: 6px; font-size: 13px; }
            thead tr.subheader-row th { top: 30px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">← Назад</a>
        <h1>Щоденні звіти</h1>
        <div class="table-card">
            <div id="loader" class="loading">Завантаження даних з Google Sheets...</div>
            <div class="table-scroll-wrap">
                <table id="dataTable" style="display: none;">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ====== CSV ПАРСЕР ======
        function parseCSV(text) {
            const rows = [];
            const lines = text.split(/\r?\n/);
            for (let line of lines) {
                if (!line.trim()) continue;
                const row = [];
                let cell = ''; let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i], nextChar = line[i + 1];
                    if (char === '"') {
                        if (inQuotes && nextChar === '"') { cell += '"'; i++; }
                        else { inQuotes = !inQuotes; }
                    } else if (char === ',' && !inQuotes) { row.push(cell.trim()); cell = ''; }
                    else { cell += char; }
                }
                row.push(cell.trim());
                if (row.some(c => c !== '')) rows.push(row);
            }
            return rows;
        }

        function cleanStr(val) { return val ? val.toString().trim() : ''; }

        // ====== ФОРМАТУВАННЯ ЧИСЕЛ ======
        function cleanNum(val) {
            if (!val) return 0;
            return parseFloat(val.toString().replace('%','').replace(/\s/g,'').replace(',','.')) || 0;
        }
        function fmtNum(val) {
            const n = cleanNum(val);
            if (n === 0 && !val) return '';
            return Math.round(n).toLocaleString('uk-UA');
        }
        function fmtPct(val) {
            const s = val ? val.toString().trim() : '';
            const hasSign = s.includes('%');
            let n = cleanNum(val);
            // Якщо значення вже містить % або більше 2 — не множимо
            if (!hasSign && n > 0 && n < 2) n = n * 100;
            return n.toFixed(2) + '%';
        }

        // ====== КОЛЬОРОВИЙ СТИЛЬ % (як у plan-fact) ======
        function getPctStyle(val) {
            const s = val ? val.toString().trim() : '';
            const hasSign = s.includes('%');
            let n = cleanNum(val);
            if (!hasSign && n > 0 && n < 2) n = n * 100;
            if (n <= 0)  return { bg: 'rgba(255,59,48,0.15)',  color: '#cc2200' };
            if (n < 50)  return { bg: 'rgba(255,59,48,0.12)',  color: '#d63b2a' };
            if (n < 80)  return { bg: 'rgba(255,149,0,0.12)',  color: '#c97000' };
            if (n < 100) return { bg: 'rgba(255,204,0,0.12)',  color: '#a07800' };
            if (n < 120) return { bg: 'rgba(52,199,89,0.12)',  color: '#248a3d' };
            return             { bg: 'rgba(52,199,89,0.22)',   color: '#1a6e30' };
        }

        // ====== ВИЗНАЧЕННЯ ГРУПИ КОЛОНКИ ======
        function getColInfo(hName) {
            const h = hName.toUpperCase();
            let group = '', type = 'fact';

            if (h.includes('ТО') && !h.includes('ТОЧ') && !h.includes('TOЧН')) {
                group = 'to';
                if (h.includes('ПЛАН')) type = 'plan';
                else if (h.includes('%') || h.includes('ВИКО')) type = 'pct';
            } else if (h.includes('ПОСЛУГ') || h.includes('ПОСЛ')) {
                group = 'serv';
                if (h.includes('ПЛАН')) type = 'plan';
                else if (h.includes('%') || h.includes('ВИКО')) type = 'pct';
                else if (h.includes('ДОЛЯ') || h.includes('SHARE')) type = 'share';
            } else if (h.includes('АСС') || h.includes('ACC') || h.includes('АКСЕС')) {
                group = 'acc';
                if (h.includes('ПЛАН')) type = 'plan';
                else if (h.includes('%') || h.includes('ВИКО')) type = 'pct';
                else if (h.includes('ДОЛЯ') || h.includes('SHARE')) type = 'share';
            } else if (h.includes('ЧЕК') || h.includes('CHECK')) {
                group = 'checks';
                if (h.includes('ПЛАН')) type = 'plan';
                else if (h.includes('%') || h.includes('ВИКО')) type = 'pct';
            }
            return { group, type };
        }

        // ====== ПОБУДОВА ЗАГОЛОВКІВ ======
        function buildHeaders(headers) {
            const thead = document.getElementById('tableHead');
            thead.innerHTML = '';

            // Перший рядок: групові заголовки
            const groupRow = document.createElement('tr');
            const thName = document.createElement('th');
            thName.rowSpan = 2;
            thName.textContent = headers[0];
            groupRow.appendChild(thName);

            // Збираємо групи
            const groupMap = [];
            let curGroup = '', startIdx = 1;
            for (let i = 1; i <= headers.length; i++) {
                const { group } = i < headers.length ? getColInfo(headers[i]) : { group: '__end' };
                if (group !== curGroup) {
                    if (curGroup !== '') groupMap.push({ group: curGroup, count: i - startIdx });
                    curGroup = group;
                    startIdx = i;
                }
            }

            const groupLabels = { 'to': 'Товарообіг', 'serv': 'Послуги', 'acc': 'Аксесуари', 'checks': 'Чеки', '': '' };

            groupMap.forEach(g => {
                const th = document.createElement('th');
                th.colSpan = g.count;
                th.className = 'group-header' + (g.group ? ' group-' + g.group : '');
                th.textContent = groupLabels[g.group] || '';
                groupRow.appendChild(th);
            });
            thead.appendChild(groupRow);

            // Другий рядок: підзаголовки
            const subRow = document.createElement('tr');
            subRow.className = 'subheader-row';
            let prevGroup = '';
            for (let i = 1; i < headers.length; i++) {
                const th = document.createElement('th');
                const { group } = getColInfo(headers[i]);
                if (group) th.className = 'group-' + group;
                if (group && group !== prevGroup) th.classList.add('group-start');
                prevGroup = group;
                // Не дублюємо назву групи в підзаголовку (напр. "ЧЕКИ" під групою "ЧЕКИ")
                // Порівнюємо без урахування регістру і пробілів
                const label = headers[i].trim().toUpperCase().replace(/\s+/g,'');
                const groupLabel = groupLabels[group] ? groupLabels[group].toUpperCase().replace(/\s+/g,'') : '';
                // Також перевіряємо скорочення (ЧЕКИ = ЧЕКИ, ЧЕК = ЧЕКИ не збігається — ок)
                const isDuplicate = groupLabel && (label === groupLabel || groupLabel.startsWith(label) && label.length >= 4);
                th.textContent = isDuplicate ? '' : headers[i];
                subRow.appendChild(th);
            }
            thead.appendChild(subRow);
        }

        // ====== ЗАВАНТАЖЕННЯ ТАБЛИЦІ ======
        async function loadTable() {
            const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQOxz-ozH9yNLW3IAzlkMlbRqOTrR4sIUO1__KpAMBFEvvpMXr4LWTnRvzYGb_y6za7WBxOUhl2DV84/pub?output=csv";
            try {
                const response = await fetch(SHEET_URL + (SHEET_URL.includes('?') ? '&' : '?') + 't=' + Date.now());
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const text = await response.text();
                if (!text || text.length < 10) throw new Error("Отримано порожній CSV");

                const rows = parseCSV(text);
                if (!rows || rows.length < 2) {
                    document.getElementById('loader').className = 'error';
                    document.getElementById('loader').textContent = "Немає даних в таблиці";
                    return;
                }

                const headers = rows[0];

                document.getElementById('loader').style.display = 'none';
                document.getElementById('dataTable').style.display = 'table';

                buildHeaders(headers);

                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';

                rows.slice(1).forEach(row => {
                    if (!row || !row[0] || !row[0].trim()) return;

                    const tr = document.createElement('tr');
                    const nameVal = cleanStr(row[0]);
                    const nameLC  = nameVal.toLowerCase();

                    const isTime    = /^\d{1,2}:\d{2}(:\d{2})?$/.test(nameVal);
                    const isSummary = nameLC.includes('виконання') || nameLC.includes('залишок')
                                   || nameLC.includes('разом') || nameLC.includes('всього')
                                   || nameLC.includes('підсумок') || nameLC.includes('total')
                                   || nameLC.includes('итого');

                    if (isTime)    tr.className = 'time-row';
                    if (isSummary) tr.className = 'summary-row';

                    // Перша колонка
                    const tdName = document.createElement('td');
                    tdName.className = 'name-cell';
                    tdName.textContent = nameVal;
                    tr.appendChild(tdName);

                    // Решта колонок
                    let prevGroup = '';
                    for (let i = 1; i < headers.length; i++) {
                        const { group, type } = getColInfo(headers[i]);
                        const val = cleanStr(row[i] || '');
                        const isGroupStart = group && group !== prevGroup;

                        if (type === 'pct' && !isTime) {
                            const { bg, color } = getPctStyle(val);
                            const td = document.createElement('td');
                            td.className = 'val-pct' + (group ? ' group-' + group : '');
                            if (isGroupStart) td.classList.add('group-start');
                            td.style.cssText = isSummary
                                ? `background:${bg}!important;color:#1d1d1f!important;font-weight:700!important`
                                : `background:${bg}!important;color:${color}!important`;
                            td.textContent = val ? fmtPct(val) : '';
                            tr.appendChild(td);
                        } else if (type === 'share' && !isTime) {
                            const td = document.createElement('td');
                            td.className = 'val-fact' + (group ? ' group-' + group : '');
                            if (isGroupStart) td.classList.add('group-start');
                            td.textContent = val;
                            tr.appendChild(td);
                        } else {
                            const td = document.createElement('td');
                            td.className = (type === 'plan' ? 'val-plan' : 'val-fact') + (group ? ' group-' + group : '');
                            if (isGroupStart) td.classList.add('group-start');
                            if (!isTime && val && val.includes('%')) {
                                td.textContent = val;
                            } else {
                                const numVal = cleanNum(val);
                                td.textContent = (!isTime && val && numVal !== 0) ? fmtNum(val) : val;
                            }
                            tr.appendChild(td);
                        }

                        prevGroup = group;
                    }

                    tbody.appendChild(tr);
                });

            } catch (e) {
                document.getElementById('loader').className = 'error';
                document.getElementById('loader').innerHTML =
                    '❌ Помилка завантаження даних<br>' +
                    '<small style="font-size:12px;color:#86868b;">' + e.message + '</small><br>' +
                    '<small style="font-size:11px;color:#86868b;margin-top:10px;display:block;">Перевірте консоль браузера (F12) для деталей</small>';
            }
        }

        loadTable();

        // ====== СВАЙП-НАВІГАЦІЯ ======
        let tX = 0, tY = 0, eX = 0, eY = 0, swiping = false;
        document.addEventListener('touchstart', e => { tX = e.changedTouches[0].screenX; tY = e.changedTouches[0].screenY; swiping = true; }, { passive: true });
        document.addEventListener('touchmove', e => {
            const mY = Math.abs(e.changedTouches[0].screenY - tY);
            const mX = Math.abs(e.changedTouches[0].screenX - tX);
            if (mY > 20 || mX < 30) swiping = false;
        }, { passive: true });
        document.addEventListener('touchend', e => {
            eX = e.changedTouches[0].screenX; eY = e.changedTouches[0].screenY;
            if (swiping && eX - tX > 120 && Math.abs(eY - tY) < 50) window.location.href = 'index.html';
            swiping = false;
        }, { passive: true });
    </script>
</body>
</html>
