<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Щоденні звіти</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        :root {
            --bg: #f5f5f7;
            --text: #1d1d1f;
            --accent: #0071e3;
            --name-w: 90px;
            --col-w: 95px;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 8px 10px;
        }

        .back-link {
            color: var(--accent);
            text-decoration: none;
            font-weight: 500;
            display: inline-block;
            margin-bottom: 6px;
            font-size: 14px;
        }

        h1 {
            font-size: 22px;
            font-weight: 700;
            margin: 0 0 10px;
        }

        .table-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-x: contain;
        }

        table {
            border-collapse: collapse;
            width: max-content;
        }

        /* STICKY ЗАГОЛОВКИ */
        thead th {
            position: sticky;
            top: 0;
            background: white;
            z-index: 5;
        }
        thead tr:nth-child(2) th {
            top: 30px;
        }

        /* STICKY ПЕРША КОЛОНКА */
        td.name-cell, th.name-th {
            position: sticky;
            left: 0;
            z-index: 6;
            background: white;
            width: var(--name-w);
            min-width: var(--name-w);
            max-width: var(--name-w);
            white-space: normal;
            word-break: break-word;
            line-height: 1.2;
            font-size: 10px;
            font-weight: 600;
            padding: 6px 5px;
            box-shadow: 2px 0 6px -2px rgba(0,0,0,0.12);
        }
        th.name-th { z-index: 15 !important; }
        thead tr:nth-child(2) th.name-th { top: 30px; z-index: 15 !important; }

        /* ГРУПОВІ ЗАГОЛОВКИ */
        th.group-header {
            text-align: center;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 7px 6px;
            border-bottom: 3px solid transparent;
        }
        th.group-header.g-to     { color: #0071e3; border-bottom-color: #0071e3; }
        th.group-header.g-serv   { color: #34c759; border-bottom-color: #34c759; }
        th.group-header.g-acc    { color: #ff9500; border-bottom-color: #ff9500; }
        th.group-header.g-checks { color: #af52de; border-bottom-color: #af52de; }
        th.group-header.g-none   { color: #86868b; border-bottom-color: #d2d2d7; }

        /* ПІДЗАГОЛОВКИ */
        th.sub-th {
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            color: #86868b;
            padding: 5px 6px;
            border-bottom: 1px solid #e0e0e5;
            white-space: nowrap;
            width: var(--col-w);
            min-width: var(--col-w);
        }
        th.sub-th.g-to     { color: #0071e3; }
        th.sub-th.g-serv   { color: #34c759; }
        th.sub-th.g-acc    { color: #ff9500; }
        th.sub-th.g-checks { color: #af52de; }

        .grp-start { border-left: 2px solid #e0e0e5 !important; }

        /* ДАНІ */
        td {
            padding: 7px 6px;
            border-bottom: 1px solid #f2f2f4;
            font-size: 12px;
            white-space: nowrap;
            width: var(--col-w);
            min-width: var(--col-w);
        }

        .val-plan   { color: #aaa; font-size: 10px; }
        .val-fact   { font-weight: 600; }
        .val-pct    { font-weight: 700; }

        .val-fact.g-to,     .val-pct.g-to     { color: #0071e3; }
        .val-fact.g-serv,   .val-pct.g-serv   { color: #34c759; }
        .val-fact.g-acc,    .val-pct.g-acc    { color: #ff9500; }
        .val-fact.g-checks, .val-pct.g-checks { color: #af52de; }

        /* СПЕЦІАЛЬНІ РЯДКИ */
        .time-row td            { background: #f5f5f7 !important; font-weight: 700; color: #333; }
        .time-row td.name-cell  { background: #f5f5f7 !important; }
        .summary-row td         { background: #eaf1fe !important; font-weight: 700; color: #1d1d1f !important; }
        .summary-row td.name-cell { background: #eaf1fe !important; }

        .loading { padding: 40px; text-align: center; color: #86868b; }
        .error   { padding: 40px; text-align: center; color: #ff3b30; }

        /* МОБІЛЬНА ВЕРСІЯ */
        @media (max-width: 767px) {
            :root {
                --name-w: 80px;
                --col-w: calc((100vw - 80px - 20px) / 3);
            }
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← Назад</a>
    <h1>Щоденні звіти</h1>

    <div class="table-card">
        <div id="loader" class="loading">Завантаження...</div>
        <table id="tbl" style="display:none">
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
        </table>
    </div>

<script>
function parseCSV(text) {
    const rows = [];
    for (const line of text.split(/\r?\n/)) {
        if (!line.trim()) continue;
        const row = []; let cell = '', q = false;
        for (let i = 0; i < line.length; i++) {
            const c = line[i];
            if (c === '"') { if (q && line[i+1]==='"') { cell+='"'; i++; } else q=!q; }
            else if (c === ',' && !q) { row.push(cell.trim()); cell=''; }
            else cell += c;
        }
        row.push(cell.trim());
        if (row.some(x => x !== '')) rows.push(row);
    }
    return rows;
}

function colInfo(h) {
    const u = h.toUpperCase();
    let g = '', t = 'fact';
    if      (u.includes('ПОСЛУГ') || u.includes('ПОСЛ'))                       g = 'serv';
    else if (u.includes('АСС') || u.includes('ACC') || u.includes('АКСЕС'))    g = 'acc';
    else if (u.includes('ЧЕК') || u.includes('CHECK'))                         g = 'checks';
    else if (/ ТО$|^ТО |^ТО$|_ТО$| ТО | ТО,|ТО\b/.test(u))                  g = 'to';

    if      (u.includes('ПЛАН'))                             t = 'plan';
    else if (u.includes('%') || u.includes('ВИКО'))          t = 'pct';
    else if (u.includes('ДОЛЯ') || u.includes('SHARE'))      t = 'share';
    return { g, t };
}

const GLABELS = { to:'Товарообіг', serv:'Послуги', acc:'Аксесуари', checks:'Чеки', '':'' };

function toNum(v) {
    if (!v) return 0;
    return parseFloat(v.toString().replace('%','').replace(/\s/g,'').replace(',','.')) || 0;
}
function fmtInt(v) {
    const n = toNum(v);
    return n ? Math.round(n).toLocaleString('uk-UA') : (v || '');
}
function fmtPct(v) {
    let n = toNum(v);
    const s = v ? v.toString() : '';
    if (!s.includes('%') && n > 0 && n < 2) n *= 100;
    return n.toFixed(2) + '%';
}
function pctBg(v) {
    let n = toNum(v);
    const s = v ? v.toString() : '';
    if (!s.includes('%') && n > 0 && n < 2) n *= 100;
    if (n <= 0)  return { bg:'rgba(255,59,48,0.13)',  fg:'#c0392b' };
    if (n < 50)  return { bg:'rgba(255,59,48,0.10)',  fg:'#d63b2a' };
    if (n < 80)  return { bg:'rgba(255,149,0,0.12)',  fg:'#b86e00' };
    if (n < 100) return { bg:'rgba(255,204,0,0.13)',  fg:'#8a6800' };
    if (n < 120) return { bg:'rgba(52,199,89,0.12)',  fg:'#1e7e34' };
    return             { bg:'rgba(52,199,89,0.20)',  fg:'#155724' };
}

function buildThead(headers) {
    const thead = document.getElementById('thead');

    // Збираємо групи
    const groups = [];
    let cur = null;
    for (let i = 1; i < headers.length; i++) {
        const { g } = colInfo(headers[i]);
        if (!cur || cur.g !== g) { cur = { g, count: 1 }; groups.push(cur); }
        else cur.count++;
    }

    // Рядок 1: групові заголовки
    const tr1 = document.createElement('tr');
    const corner = document.createElement('th');
    corner.rowSpan = 2;
    corner.className = 'name-th';
    corner.textContent = headers[0];
    tr1.appendChild(corner);
    for (const grp of groups) {
        const th = document.createElement('th');
        th.colSpan = grp.count;
        th.className = 'group-header g-' + (grp.g || 'none');
        th.textContent = GLABELS[grp.g] || '';
        tr1.appendChild(th);
    }
    thead.appendChild(tr1);

    // Рядок 2: підзаголовки
    const tr2 = document.createElement('tr');
    let prevG = '';
    for (let i = 1; i < headers.length; i++) {
        const { g } = colInfo(headers[i]);
        const th = document.createElement('th');
        th.className = 'sub-th' + (g ? ' g-' + g : '');
        if (g !== prevG) th.classList.add('grp-start');
        prevG = g;
        // Не дублюємо назву групи
        const lbl = headers[i].trim().toUpperCase();
        const glbl = (GLABELS[g] || '').toUpperCase();
        th.textContent = (glbl && lbl === glbl) ? '' : headers[i];
        tr2.appendChild(th);
    }
    thead.appendChild(tr2);
}

async function load() {
    const SHEET = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQOxz-ozH9yNLW3IAzlkMlbRqOTrR4sIUO1__KpAMBFEvvpMXr4LWTnRvzYGb_y6za7WBxOUhl2DV84/pub?output=csv";
    try {
        const res = await fetch(SHEET + '&t=' + Date.now());
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const rows = parseCSV(await res.text());
        if (rows.length < 2) throw new Error('Немає даних');

        const headers = rows[0];
        document.getElementById('loader').style.display = 'none';
        document.getElementById('tbl').style.display = '';

        buildThead(headers);

        const tbody = document.getElementById('tbody');
        for (const row of rows.slice(1)) {
            if (!row[0] || !row[0].trim()) continue;
            const name   = row[0].trim();
            const nameLC = name.toLowerCase();
            const isTime = /^\d{1,2}:\d{2}(:\d{2})?$/.test(name);
            const isSummary = ['виконання','залишок','разом','всього','підсумок','total','итого']
                              .some(k => nameLC.includes(k));

            const tr = document.createElement('tr');
            if (isTime)    tr.className = 'time-row';
            if (isSummary) tr.className = 'summary-row';

            // Перша колонка (ПК)
            const tdN = document.createElement('td');
            tdN.className = 'name-cell';
            tdN.textContent = name;
            tr.appendChild(tdN);

            let prevG = '';
            for (let i = 1; i < headers.length; i++) {
                const { g, t } = colInfo(headers[i]);
                const val      = (row[i] || '').trim();
                const isStart  = g !== prevG;
                prevG = g;

                const td = document.createElement('td');
                if (isStart && g) td.classList.add('grp-start');

                if (t === 'pct' && !isTime) {
                    const { bg, fg } = pctBg(val);
                    td.className = 'val-pct' + (g ? ' g-' + g : '');
                    if (isStart && g) td.classList.add('grp-start');
                    td.style.background = bg;
                    td.style.color = isSummary ? '#1d1d1f' : fg;
                    td.textContent = val ? fmtPct(val) : '';
                } else if (t === 'share') {
                    td.className = 'val-fact' + (g ? ' g-' + g : '');
                    td.textContent = val;
                } else if (t === 'plan') {
                    td.className = 'val-plan' + (g ? ' g-' + g : '');
                    td.textContent = isTime ? val : fmtInt(val);
                } else {
                    td.className = 'val-fact' + (g ? ' g-' + g : '');
                    td.textContent = (!isTime && val && !val.includes('%')) ? fmtInt(val) : val;
                }
                tr.appendChild(td);
            }
            tbody.appendChild(tr);
        }
    } catch(e) {
        const el = document.getElementById('loader');
        el.className = 'error';
        el.textContent = '❌ ' + e.message;
    }
}

load();

// Свайп назад
let x0=0, y0=0, sw=false;
document.addEventListener('touchstart', e=>{x0=e.changedTouches[0].screenX; y0=e.changedTouches[0].screenY; sw=true;},{passive:true});
document.addEventListener('touchmove',  e=>{if(Math.abs(e.changedTouches[0].screenY-y0)>25) sw=false;},{passive:true});
document.addEventListener('touchend',   e=>{
    if(sw && e.changedTouches[0].screenX-x0>120 && Math.abs(e.changedTouches[0].screenY-y0)<50)
        window.location.href='index.html';
    sw=false;
},{passive:true});
</script>
</body>
</html>
