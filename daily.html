<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Sales — Apple Style</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        :root { --bg: #f5f5f7; --text: #1d1d1f; --accent: #0071e3; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        .container { max-width: 1400px; margin: 20px auto; }
        .back-link { color: var(--accent); text-decoration: none; font-weight: 500; display: inline-block; margin-bottom: 20px; }
        h1 { font-size: 32px; font-weight: 600; margin-bottom: 20px; letter-spacing: -0.5px; }
        
        .table-card { 
            background: white; 
            border-radius: 22px; 
            box-shadow: 0 8px 30px rgba(0,0,0,0.04); 
            overflow-x: auto; 
        }

        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { text-align: left; padding: 16px; color: #86868b; font-size: 11px; font-weight: 600; text-transform: uppercase; border-bottom: 1px solid #d2d2d7; background: white; }
        td { padding: 16px; border-bottom: 1px solid #f5f5f7; font-size: 14px; white-space: nowrap; }
        
        /* ДЕСКТОПНА ВЕРСІЯ: компактніша таблиця */
        @media (min-width: 768px) {
            table { min-width: auto; width: 100%; }
            th { padding: 12px 8px; font-size: 10px; }
            td { padding: 12px 8px; font-size: 12px; }
            .name-cell, th:first-child { 
                min-width: 120px;
                max-width: 120px;
                padding: 12px 8px;
                font-size: 12px;
            }
        }
        
        /* ФІКСОВАНА КОЛОНКА ПІБ */
        .name-cell, th:first-child { 
            position: sticky; 
            left: 0; 
            background: white; 
            z-index: 10; 
            min-width: 180px; 
            box-shadow: 4px 0 8px -4px rgba(0,0,0,0.1);
        }
        th:first-child { z-index: 11; }

        /* КОЛЬОРИ СТОВПЦІВ */
        .col-to { color: #34c759; font-weight: 600; }
        .col-poslugi { color: #af52de; font-weight: 600; }
        .col-acc { color: #ff9500; font-weight: 600; }
        .col-cheky { color: #0071e3; font-weight: 600; }
        
        /* КОЛОНКИ ПЛАН - сірий і менший шрифт */
        .col-plan { color: #86868b; font-size: 12px; font-weight: 400; }

        /* СТРОКА З ЧАСОМ */
        .time-row { background: #f5f5f7 !important; font-weight: 800 !important; }
        .time-row td { color: #000; }
        .time-row .name-cell { background: #f5f5f7 !important; }
        
        /* СТРОКИ ВИКОНАННЯ ТА ЗАЛИШОК */
        .summary-row { background: #fafafa !important; font-weight: 700 !important; }
        .summary-row td { color: #1d1d1f !important; }
        .summary-row .name-cell { background: #fafafa !important; }

        .loading { padding: 40px; text-align: center; color: #86868b; }
        .error { padding: 40px; text-align: center; color: #ff3b30; }

        /* МОБІЛЬНА ВЕРСІЯ: ЗМЕНШЕННЯ ШРИФТУ ПІБ */
        @media (max-width: 600px) {
            .name-cell, th:first-child { 
                min-width: 80px; 
                max-width: 80px;
                padding: 10px 5px;
                font-size: 10px;
                white-space: normal;
                line-height: 1.1;
                text-align: center;
            }
            
            td:not(.name-cell) {
                padding: 12px 8px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">← Назад</a>
        <h1>Щоденні звіти</h1>
        <div class="table-card">
            <div id="loader" class="loading">Завантаження даних з Google Sheets...</div>
            <table id="dataTable" style="display: none;">
                <thead><tr id="headerRow"></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
    <script>
        // Покращений парсер CSV
        function parseCSV(text) {
            const rows = [];
            const lines = text.split(/\r?\n/);
            
            for (let line of lines) {
                if (!line.trim()) continue; // Пропускаємо порожні рядки
                
                const row = [];
                let cell = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];
                    
                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            // Подвійні лапки всередині лапок
                            cell += '"';
                            i++; // Пропускаємо наступну лапку
                        } else {
                            // Початок або кінець лапок
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        // Роздільник колонок
                        row.push(cell.trim());
                        cell = '';
                    } else {
                        cell += char;
                    }
                }
                
                // Додаємо останню комірку
                row.push(cell.trim());
                
                if (row.length > 0 && row.some(c => c !== '')) {
                    rows.push(row);
                }
            }
            
            return rows;
        }

        // Очищення значення
        function cleanVal(val) {
            if (!val) return "";
            return val.toString().trim();
        }

        async function loadTable() {
            // URL вашої Google таблиці для daily sales
            // ЗАМІНІТЬ на правильний URL вашої таблиці для щоденних звітів!
            const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQOxz-ozH9yNLW3IAzlkMlbRqOTrR4sIUO1__KpAMBFEvvpMXr4LWTnRvzYGb_y6za7WBxOUhl2DV84/pub?output=csv";
            
            try {
                console.log("Завантаження даних з:", SHEET_URL);
                
                // Додаємо timestamp для уникнення кешування
                const url = SHEET_URL + (SHEET_URL.includes('?') ? '&' : '?') + 't=' + Date.now();
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                console.log("Отримано CSV, довжина:", text.length);
                
                if (!text || text.length < 10) {
                    throw new Error("Отримано порожній або занадто короткий CSV");
                }
                
                const rows = parseCSV(text);
                console.log("Розпарсено рядків:", rows.length);

                if (!rows || rows.length < 2) {
                    document.getElementById('loader').className = 'error';
                    document.getElementById('loader').textContent = "Немає даних в таблиці";
                    return;
                }

                // Приховуємо loader, показуємо таблицю
                document.getElementById('loader').style.display = 'none';
                document.getElementById('dataTable').style.display = 'table';

                // Отримуємо заголовки (перший рядок)
                const headers = rows[0];
                console.log("Заголовки:", headers);
                
                const hRow = document.getElementById('headerRow');
                hRow.innerHTML = ''; // Очищаємо попередні заголовки
                
                headers.forEach(h => {
                    let th = document.createElement('th');
                    th.textContent = h;
                    hRow.appendChild(th);
                });

                // Заповнюємо дані (всі рядки крім першого)
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = ''; // Очищаємо попередні дані
                
                const dataRows = rows.slice(1);
                console.log("Рядків з даними:", dataRows.length);

                dataRows.forEach((row, idx) => {
                    // Пропускаємо порожні рядки
                    if (!row || row.length === 0 || !row[0] || row[0].trim() === '') {
                        console.log("Пропущено порожній рядок:", idx + 2);
                        return;
                    }

                    let tr = document.createElement('tr');
                    const nameVal = cleanVal(row[0]);
                    
                    // Якщо в першій колонці час (формат HH:MM:SS) - це строка з часом
                    if (nameVal.match(/^\d{2}:\d{2}:\d{2}$/)) {
                        tr.className = 'time-row';
                        console.log("Знайдено рядок з часом:", nameVal);
                    }
                    
                    // Виконання та Залишок - чорний шрифт
                    const rowName = row[0].toString().toLowerCase().trim();
                    if (rowName.includes('виконання') || rowName.includes('залишок')) {
                        tr.className = 'summary-row';
                    }

                    // Додаємо клітинки для кожної колонки
                    for (let i = 0; i < headers.length; i++) {
                        let td = document.createElement('td');
                        let val = cleanVal(row[i] || '');
                        
                        if (i === 0) {
                            // Перша колонка - ПІБ або час
                            td.className = 'name-cell';
                            td.textContent = val;
                        } else {
                            // Інші колонки - числа
                            td.textContent = val;
                            
                            // Застосовуємо кольори в залежності від назви колонки
                            const hName = headers[i].toUpperCase();
                            
                            // Колонки План - сірий колір
                            if (hName.includes('ПЛАН ТО') || hName.includes('ПЛАН ПОСЛУГИ') || hName.includes('ПЛАН АСС')) {
                                td.classList.add('col-plan');
                            }
                            // Група ТО (зелений) - тільки Факт і %
                            else if (hName.includes('ФАКТ ТО') || hName.includes('% ТО')) {
                                td.classList.add('col-to');
                            } 
                            // Група Послуги (фіолетовий) - тільки Факт і Доля
                            else if (hName.includes('ФАКТ ПОСЛУГИ') || hName.includes('ДОЛЯ ПОСЛУГ')) {
                                td.classList.add('col-poslugi');
                            } 
                            // Група АСС (помаранчевий) - тільки Факт і Доля
                            else if (hName.includes('ФАКТ АСС') || hName.includes('ДОЛЯ АСС')) {
                                td.classList.add('col-acc');
                            } 
                            // Чеки (синій)
                            else if (hName === 'ЧЕКИ' || hName.includes('ЧЕК')) {
                                td.classList.add('col-cheky');
                            }
                        }
                        tr.appendChild(td);
                    }
                    tbody.appendChild(tr);
                });
                
                console.log("Таблиця успішно побудована");

            } catch (e) {
                console.error("Помилка завантаження:", e);
                document.getElementById('loader').className = 'error';
                document.getElementById('loader').innerHTML = 
                    "❌ Помилка завантаження даних<br>" +
                    "<small style='font-size: 12px; color: #86868b;'>" + e.message + "</small><br>" +
                    "<small style='font-size: 11px; color: #86868b; margin-top: 10px; display: block;'>" +
                    "Перевірте консоль браузера (F12) для деталей</small>";
            }
        }

        // Завантажуємо дані при відкритті сторінки
        loadTable();

        // СВАЙП-НАВІГАЦІЯ
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;
        let isSwiping = false;
        
        function handleSwipe() {
            const swipeThreshold = 120;
            const swipeDistanceX = touchEndX - touchStartX;
            const swipeDistanceY = Math.abs(touchEndY - touchStartY);
            
            if (isSwiping && Math.abs(swipeDistanceX) > swipeThreshold && swipeDistanceX > 0 && swipeDistanceY < 50) {
                window.location.href = 'index.html';
            }
        }
        
        document.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
            isSwiping = true;
        }, { passive: true });
        
        document.addEventListener('touchmove', e => {
            const moveY = Math.abs(e.changedTouches[0].screenY - touchStartY);
            const moveX = Math.abs(e.changedTouches[0].screenX - touchStartX);
            if (moveY > 20 || moveX < 30) {
                isSwiping = false;
            }
        }, { passive: true });
        
        document.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            touchEndY = e.changedTouches[0].screenY;
            handleSwipe();
            isSwiping = false;
        }, { passive: true });
    </script>
</body>
</html>
